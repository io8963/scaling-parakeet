# autobuild.yml

name: Build Blog

# 【关键修复】触发条件：推送到 main 或任何其他分支时执行，以及 PR 动作
on:
  push:
    branches:
      - main
      - '*' # 确保此行存在：捕获所有分支的推送事件，包括您的测试分支
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 关键修复：添加 contents: write 权限，允许 GITHUB_TOKEN 推送更改
    permissions:
      contents: write

    steps:
    - name: Checkout Repository (Full History)
      uses: actions/checkout@v4
      with:
          fetch-depth: 0
      
    - name: Set up Python
      # 2. 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.x' 
        
    # 优化建议 6: 启用 Pip 缓存以加速 CI/CD
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Install Python Dependencies
      # 3. 关键修复：安装所需的 Python 库，包括 Jinja2
      run: |
        pip install -r requirements.txt
        
    - name: Create Posts Directory (if not exists)
      # 4. 确保 posts 目录存在
      # 注意：根据您的 config.py，Markdown 源文件目录是 'markdown'
      run: |
        mkdir -p markdown
        
    - name: Run Autobuild Script (Generate all static files)
      # 5. 运行 Python 脚本，执行 Markdown 转换
      run: python autobuild.py
      
    # 6. Cloudflare Pages 会自动检测 _site 目录并部署
